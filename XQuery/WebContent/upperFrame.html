<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Input Frame</title>
<!-- jQuery -->
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
<style type="text/css">
body {
	font-family:verdana,arial,sans-serif;
	font-size:10pt;
	margin:30px;
	background-color:#ffffff;
	}
</style>
</head>
<body>
<h3>XQuery Expression: <a href=""> Help for XQuery expression regulations</a> </h3> 
<div name="content">
<table><tr>
<td><textarea id="expression" rows="12" cols="100"></textarea></td>
<td style="text-align: left;vertical-align: top;padding-top: 5%"><input type="button" value="Do XQuery" onclick="doQuery()"></td>
</tr></table>
</div>
<script type="text/javascript">
function doQuery() {
		var expr = $("#expression").val();
	    $.ajax({
	    	type: "GET",
		  	url: "/XQuery/QueryFromDB",
		  	data: "expr="+expr,
		  	cache: false,
		  	dataType: "xml"
		})
		.done(function(xml) {
			var xmlString;
			var xmlFormatted;
			var xmlString = (new XMLSerializer()).serializeToString(xml);
			//alert(xmlString); 
	    	xmlFormatted = formatXml(xmlString)
			xmlFormatted = xmlFormatted.replace(/</g,"&lt;");
			showResult = "<pre class=\"prettyprint\">";
			showResult = showResult + xmlFormatted;
			showResult = showResult + "</pre>";
			
	    	// Do XML format in client side
		  	window.parent.frames["lower"].document.getElementById("result").innerHTML = showResult;
		    window.parent.frames["lower"].prettyPrint();
		})
		.fail(function() { 
		  	alert("error"); 
		}); 
		
	    // although it seems lack of quotes, but the RegExp functions should works with no quotes
	    function formatXml(xml) {
	    	var formatted = '';
	    	var reg = /(>)(<)(\/*)/g;
	    	xml = xml.replace(reg, '$1\r\n$2$3');
	    	var pad = 0;
	    	jQuery.each(xml.split('\r\n'), function(index, node) {
		    	var indent = 0;
		    	if (node.match( /.+<\/\w[^>]*>$/ )) {
		    		indent = 0;
		    	} else if (node.match( /^<\/\w/ )) {
		    		if (pad != 0) {
		    		pad -= 1;
		    	}
		    	} else if (node.match( /^<\w[^>]*[^\/]>.*$/ )) {
		    		indent = 1;
		    	} else {
		    		indent = 0;
		    	}
	    	 
		    	var padding = '';
		    	for (var i = 0; i < pad; i++) {
		    		padding += ' ';
	    		}
	    	 
		    	formatted += padding + node + '\r\n';
		    	pad += indent;
	    	});
	    	 
	    	return formatted;
	    }
	    
	    /*
		$.get('/XQuery/test.xml',function(data){
			$('#content').empty();
			    var xmlString;
			    //IE
			    if (window.ActiveXObject){
			        xmlString = data.xml;
			    }
			    // code for Mozilla, Firefox, Opera, etc.
			    else{
			    	var s = (new XMLSerializer()).serializeToString(data);
			    	s = s.replace(/</g,"&lt;");
			    	xmlString = "<pre class=\"prettyprint\">";
			        xmlString = xmlString + s;
			    	xmlString = xmlString + "</pre>";
			    }
			    window.parent.frames["lower"].document.getElementById("result").innerHTML = xmlString;
			    window.parent.frames["lower"].prettyPrint();
		});	
		*/
}

</script>
</body>
</html>
